<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Valuation – Extração Profissional</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
body { font-family: Arial; background:#f5f5f5; padding:20px }
.card { background:#fff; padding:20px; border-radius:8px; max-width:900px; margin:auto }
h2 { margin-top:0 }
input { width:100%; padding:6px; margin-bottom:10px }
.ok { color:green; font-weight:bold }
.bad { color:red; font-weight:bold }
</style>
</head>

<body>
<div class="card">
<h2>Valuation – Motor Robusto</h2>

<input type="file" id="excelInput">

<h3>Resultados Extraídos</h3>

<label>EBIT</label>
<input id="ebit">

<label>NOPAT</label>
<input id="nopat">

<label>Capital Investido</label>
<input id="capital">

<label>ROIC (%)</label>
<input id="roic">

<label>Reinvestimento</label>
<input id="reinv">

<label>FCF</label>
<input id="fcf">

<label>Teste Ciclo Ruim</label>
<input id="stress">

<div id="status"></div>
</div>

<script>
// ============================
// FUNÇÕES BASE (PADRÃO EXCEL)
// ============================
function num(v) {
    if (v === null || v === undefined) return null;
    const n = Number(
        String(v).replace(/\./g,'').replace(',','.').replace(/[^\d\-\.]/g,'')
    );
    return isNaN(n) ? null : n;
}

function ultimoNumero(linha) {
    for (let i = linha.length - 1; i >= 0; i--) {
        const n = num(linha[i]);
        if (n !== null) return n;
    }
    return null;
}

function acharLinha(sheet, termos) {
    return sheet.find(l =>
        termos.some(t => String(l[0]).toLowerCase().includes(t))
    );
}

// ============================
// PROCESSAMENTO
// ============================
document.getElementById('excelInput').addEventListener('change', e => {

const reader = new FileReader();
reader.onload = evt => {

const wb = XLSX.read(new Uint8Array(evt.target.result), { type:'array' });

const dreName = wb.SheetNames.find(n => n.toLowerCase().includes('result'));
const balName = wb.SheetNames.find(n => n.toLowerCase().includes('balan'));

if (!dreName || !balName) {
    document.getElementById('status').innerHTML =
        '<p class="bad">DRE ou Balanço não encontrados</p>';
    return;
}

const dre = XLSX.utils.sheet_to_json(wb.Sheets[dreName], { header:1, defval:'' });
const bal = XLSX.utils.sheet_to_json(wb.Sheets[balName], { header:1, defval:'' });

// ============================
// EXTRAÇÕES
// ============================
const ebit = ultimoNumero(acharLinha(dre,['ebit','lucro operacional']));
const imposto = 0.30;
const nopat = ebit * (1 - imposto);

const caixa = ultimoNumero(acharLinha(bal,['caixa']));
const imob = ultimoNumero(acharLinha(bal,['imobilizado']));
const intang = ultimoNumero(acharLinha(bal,['intang']));

const fornecedores = ultimoNumero(acharLinha(bal,['forneced']));
const clientes = ultimoNumero(acharLinha(bal,['receber']));
const estoques = ultimoNumero(acharLinha(bal,['estoq']));

// ============================
// CAPITAL INVESTIDO (FLEURIET)
// ============================
const aco = (clientes || 0) + (estoques || 0);
const pco = (fornecedores || 0);
const capital = aco - pco + (imob || 0) + (intang || 0);

// ============================
// REINVESTIMENTO
// ============================
const reinv = capital * 0.05; // conservador

// ============================
// ROIC & FCF
// ============================
const roic = nopat / capital;
const fcf = nopat - reinv;

// ============================
// TESTE CICLO RUIM
// ============================
const stress = (fcf > 0 && roic > 0.08)
    ? 'Resiliente'
    : 'Risco em crise';

// ============================
// OUTPUT
// ============================
document.getElementById('ebit').value = ebit.toFixed(0);
document.getElementById('nopat').value = nopat.toFixed(0);
document.getElementById('capital').value = capital.toFixed(0);
document.getElementById('roic').value = (roic*100).toFixed(1);
document.getElementById('reinv').value = reinv.toFixed(0);
document.getElementById('fcf').value = fcf.toFixed(0);
document.getElementById('stress').value = stress;

document.getElementById('status').innerHTML =
'<p class="ok">✔ Extração concluída com sucesso</p>';

};

reader.readAsArrayBuffer(e.target.files[0]);
});
</script>
</body>
</html>
