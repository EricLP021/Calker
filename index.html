import pandas as pd
import numpy as np

def realizar_valuation_trimodal(caminho_planilha):
    """
    Realiza a análise completa baseada nas abas 'Bal. Patrim.' e 'Dem. Result.'
    conforme as diretrizes de qualidade, Fleuriet e Assaf Neto.
    """
    
    # 1. CARREGAMENTO DOS DADOS (Referência apenas às abas solicitadas)
    # A planilha tem as contas nas linhas e períodos nas colunas.
    try:
        df_balanco = pd.read_excel(caminho_planilha, sheet_name='Bal. Patrim.', index_col=0)
        df_dre = pd.read_excel(caminho_planilha, sheet_name='Dem. Result.', index_col=0)
    except Exception as e:
        return f"Erro ao ler as abas: {e}"

    # Selecionar a coluna mais recente (última coluna com dados reais)
    coluna_atual = df_balanco.columns[-1]
    coluna_anterior = df_balanco.columns[-5] # Aproximação para 1 ano atrás (4 trimestres)

    # 2. CAPTURA DE VARIÁVEIS - BALANÇO PATRIMONIAL
    ativo_total = df_balanco.loc['Ativo Total', coluna_atual]
    ativo_circulante = df_balanco.loc['Ativo Circulante', coluna_atual]
    passivo_circulante = df_balanco.loc['Passivo Circulante', coluna_atual]
    caixa_equivalentes = df_balanco.loc['Caixa e Equivalentes de Caixa', coluna_atual]
    contas_receber = df_balanco.loc['Contas a Receber', coluna_atual]
    estoques = df_balanco.loc['Estoques', coluna_atual]
    patrimonio_liquido = df_balanco.loc['Patrimônio Líquido', coluna_atual]
    divida_cp = df_balanco.loc['Empréstimos e Financiamentos', coluna_atual] # Passivo Circulante
    divida_lp = df_balanco.loc['Empréstimos e Financiamentos.1', coluna_atual] if 'Empréstimos e Financiamentos.1' in df_balanco.index else 0
    
    # 3. CAPTURA DE VARIÁVEIS - DRE E FCO (Assumindo que estão na aba Dem. Result. ou similar)
    receita_liquida = df_dre.loc['Receita Líquida', coluna_atual]
    ebit = df_dre.loc['EBIT', coluna_atual]
    lucro_liquido = df_dre.loc['Lucro Líquido', coluna_atual]
    depreciacao = df_dre.loc['Depreciação e Amortização', coluna_atual]
    fco = df_dre.loc['Fluxo de Caixa Operacional', coluna_atual] # Capturado da DRE/Fluxo
    capex = df_dre.loc['CAPEX', coluna_atual]
    
    # 4. MODELO FLEURIET (NCG E SALDO DE TESOURARIA)
    # Ativo Circulante Operacional (Ciclo Financeiro)
    aco = contas_receber + estoques 
    # Passivo Circulante Operacional (Fornecedores, etc)
    pco = df_balanco.loc['Fornecedores', coluna_atual] + df_balanco.loc['Obrigações Sociais e Trabalhistas', coluna_atual]
    
    ncg = aco - pco
    saldo_tesouraria = caixa_equivalentes - divida_cp
    
    # 5. COMBO DE QUALIDADE
    # Eficiência de Caixa: (EBITDA - Variação NCG) / EBITDA
    ebitda = ebit + depreciacao
    var_ncg = ncg - (df_balanco.loc['Contas a Receber', coluna_anterior] + df_balanco.loc['Estoques', coluna_anterior] - 
                     (df_balanco.loc['Fornecedores', coluna_anterior] + df_balanco.loc['Obrigações Sociais e Trabalhistas', coluna_anterior]))
    
    eficiencia_caixa = (ebitda - var_ncg) / ebitda if ebitda != 0 else 0
    accruals_ratio = (lucro_liquido - fco) / ativo_total
    margem_fco = (ebitda - var_ncg - (lucro_liquido * 0.34)) / receita_liquida # 34% de impostos estimados
    
    # 6. VALUATION (PÓVOA E ASSAF NETO)
    aliquota_efetiva = 0.34 # Conforme diretriz padrão
    nopat = ebit * (1 - aliquota_efetiva)
    
    # ROIC e Reinvestimento
    capital_investido = patrimonio_liquido + (divida_cp + divida_lp) - caixa_equivalentes
    roic = nopat / capital_investido if capital_investido != 0 else 0
    taxa_reinvestimento = (capex + var_ncg) / nopat if nopat != 0 else 0
    
    # Crescimento Sustentável (g)
    g = taxa_reinvestimento * roic
    
    # FCFE e Preço Teto
    # FCFE = Lucro Líquido + Depreciação - CAPEX - Var_NCG + Novas Dívidas - Amortizações
    fcfe = lucro_liquido + depreciacao - capex - var_ncg
    yield_desejado = 0.08 # Mínimo de 8% conforme instruções
    
    # Preço Teto Bazin Adaptado (Dividendo Sustentável)
    # Assume-se que o FCFE é a capacidade máxima de provento sustentável
    preco_teto_bazin = (fcfe / 1) / yield_desejado # Ajustar por número de ações se disponível
    
    # 7. OUTPUT FORMATADO
    resultados = {
        "Data de Referência": coluna_atual,
        "--- MODELO FLEURIET ---": "",
        "NCG (Necessidade de Capital de Giro)": f"R$ {ncg:,.2f}",
        "Saldo de Tesouraria": f"R$ {saldo_tesouraria:,.2f}",
        "NCG / Receita Líquida": f"{(ncg / receita_liquida) * 100:.2f}%",
        "--- COMBO DE QUALIDADE ---": "",
        "Eficiência de Caixa (EBITDA-ΔNCG)/EBITDA": f"{eficiencia_caixa:.2f}",
        "Accruals Ratio (Qualidade do Lucro)": f"{accruals_ratio:.4f} (Negativo é ideal)",
        "Margem de Fluxo de Caixa (Real/Dinheiro Vivo)": f"{margem_fco * 100:.2f}%",
        "--- VALUATION & RETORNO ---": "",
        "ROIC": f"{roic * 100:.2f}%",
        "Crescimento Sustentável (g)": f"{g * 100:.2f}%",
        "FCF Yield": f"{(fcfe / (patrimonio_liquido)) * 100:.2f}% (Sobre PL)",
        "Preço Teto Estimado (Bazin 8%)": f"R$ {preco_teto_bazin:,.2f} (Base FCFE Total)"
    }
    
    return resultados

# Execução exemplo
# print(realizar_valuation_trimodal("caminho_da_planilha.xlsx"))
