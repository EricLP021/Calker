<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valuation Pro - Automatizado</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f4f7f6; padding: 20px; color: #333; }
        .container { max-width: 1100px; margin: 0 auto; }
        .card { background: white; border-radius: 10px; padding: 25px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        h1, h2 { margin-bottom: 15px; color: #2c3e50; }
        .grid { display: grid; gap: 15px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
        .input-group { margin-bottom: 10px; }
        label { display: block; font-weight: bold; font-size: 12px; margin-bottom: 5px; color: #555; }
        input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; background: #fff; }
        input.auto-filled { border-color: #3498db; background: #ebf5fb; }
        .btn { padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; width: 100%; transition: 0.2s; }
        .btn-calc { background: #27ae60; color: white; font-size: 16px; margin-top: 15px; }
        .btn-calc:hover { background: #219150; }
        .res-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .val-box { padding: 25px; border-radius: 10px; text-align: center; color: white; }
        .dcf-box { background: #2ecc71; }
        .bazin-box { background: #3498db; }
        .price { font-size: 40px; font-weight: 800; margin: 10px 0; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; font-size: 13px; }
        th { background: #f8f9fa; }
        .badge { padding: 3px 7px; border-radius: 4px; font-size: 11px; font-weight: bold; }
        .badge-manual { background: #f39c12; color: white; }
        .badge-auto { background: #3498db; color: white; }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <h1>üìä Terminal de Valuation Autom√°tico</h1>
        <p style="margin-bottom: 15px;">Importe o Excel do Fundamentus. O sistema extrair√° os dados e voc√™ revisa/completa os campos em laranja.</p>
        <input type="file" id="excelInput" accept=".xls,.xlsx" style="padding: 10px; border: 2px dashed #3498db; width: 100%; cursor: pointer;">
        <div id="status"></div>
    </div>

    <div class="card">
        <h2>üìë Dados Extra√≠dos (Revis√£o Necess√°ria)</h2>
        <div class="grid">
            <div class="input-group"><label>EBIT (12m) <span class="badge badge-auto">Auto</span></label><input type="number" id="ebit" class="auto-filled"></div>
            <div class="input-group"><label>Lucro L√≠quido <span class="badge badge-auto">Auto</span></label><input type="number" id="lucroLiq" class="auto-filled"></div>
            <div class="input-group"><label>Receita L√≠quida <span class="badge badge-auto">Auto</span></label><input type="number" id="receita" class="auto-filled"></div>
            <div class="input-group"><label>Ativo Total <span class="badge badge-auto">Auto</span></label><input type="number" id="ativo" class="auto-filled"></div>
            <div class="input-group"><label>Varia√ß√£o NCG <span class="badge badge-auto">Auto</span></label><input type="number" id="ncgVar" class="auto-filled"></div>
            <div class="input-group"><label>Patrim√¥nio L√≠quido <span class="badge badge-auto">Auto</span></label><input type="number" id="pl" class="auto-filled"></div>
            
            <div class="input-group"><label>Deprecia√ß√£o/Amort. <span class="badge badge-manual">Digitar</span></label><input type="number" id="depre" placeholder="Ver fluxo de caixa"></div>
            <div class="input-group"><label>CAPEX <span class="badge badge-manual">Digitar</span></label><input type="number" id="capex" placeholder="Ver fluxo de caixa"></div>
            <div class="input-group"><label>N¬∫ de A√ß√µes <span class="badge badge-manual">Digitar</span></label><input type="number" id="numAcoes"></div>
        </div>
    </div>

    <div class="card">
        <h2>‚öôÔ∏è Par√¢metros de Mercado</h2>
        <div class="grid">
            <div class="input-group"><label>Taxa de Desconto (DI+2%)</label><input type="number" id="ke" value="13.5"></div>
            <div class="input-group"><label>Crescimento Perp√©tuo (g)</label><input type="number" id="g" value="3"></div>
            <div class="input-group"><label>Yield Desejado (Bazin)</label><input type="number" id="yieldBazin" value="8"></div>
            <div class="input-group"><label>Payout Estimado (%)</label><input type="number" id="payout" value="30"></div>
        </div>
        <button class="btn btn-calc" onclick="calcularTudo()">CALCULAR VALUATION COMPLETO</button>
    </div>

    <div id="resultado" class="hidden"></div>
</div>

<script>
    function parseV(val) {
        if (!val) return 0;
        return parseFloat(String(val).replace(/\./g, '').replace(',', '.')) || 0;
    }

    document.getElementById('excelInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = function(evt) {
            const data = new Uint8Array(evt.target.result);
            const wb = XLSX.read(data, {type: 'array'});
            
            const dre = XLSX.utils.sheet_to_json(wb.Sheets[wb.Sheets['DRE'] ? 'DRE' : wb.SheetNames[0]], {header:1});
            const bal = XLSX.utils.sheet_to_json(wb.Sheets[wb.Sheets['Balan√ßo'] ? 'Balan√ßo' : wb.SheetNames[1]], {header:1});

            // Extra√ß√£o DRE
            dre.forEach(row => {
                let t = String(row[0]).toLowerCase();
                if(t.includes('ebit') || t.includes('resultado operacional')) document.getElementById('ebit').value = parseV(row[1]);
                if(t.includes('l√≠quido') && !t.includes('receita')) document.getElementById('lucroLiq').value = parseV(row[1]);
                if(t.includes('receita l√≠quida')) document.getElementById('receita').value = parseV(row[1]);
            });

            // Extra√ß√£o Balan√ßo (NCG Simplificada: Ativo Circ - Passivo Circ)
            let ac = 0, acAnt = 0, pc = 0, pcAnt = 0;
            bal.forEach(row => {
                let t = String(row[0]).toLowerCase();
                if(t.includes('ativo total')) document.getElementById('ativo').value = parseV(row[1]);
                if(t.includes('patrim√¥nio l√≠quido')) document.getElementById('pl').value = parseV(row[1]);
                
                if(t === 'ativo circulante') { ac = parseV(row[1]); acAnt = parseV(row[2]); }
                if(t === 'passivo circulante') { pc = parseV(row[1]); pcAnt = parseV(row[2]); }
            });

            if(ac && pc) {
                const ncgAtual = ac - pc;
                const ncgAnt = acAnt - pcAnt;
                document.getElementById('ncgVar').value = (ncgAtual - ncgAnt).toFixed(2);
            }

            document.getElementById('status').innerHTML = '<p style="color: #27ae60; font-weight: bold; margin-top: 10px;">‚úì Dados importados! Revise os campos em azul e complete os em laranja.</p>';
        };
        reader.readAsArrayBuffer(file);
    });

    function calcularTudo() {
        // Inputs
        const lucro = parseFloat(document.getElementById('lucroLiq').value) || 0;
        const ebit = parseFloat(document.getElementById('ebit').value) || 0;
        const receita = parseFloat(document.getElementById('receita').value) || 1;
        const depre = parseFloat(document.getElementById('depre').value) || 0;
        const capex = parseFloat(document.getElementById('capex').value) || 0;
        const ncgVar = parseFloat(document.getElementById('ncgVar').value) || 0;
        const ativo = parseFloat(document.getElementById('ativo').value) || 1;
        const pl = parseFloat(document.getElementById('pl').value) || 1;
        const numAcoes = parseFloat(document.getElementById('numAcoes').value) || 1;
        const ke = parseFloat(document.getElementById('ke').value) / 100;
        const g = parseFloat(document.getElementById('g').value) / 100;
        const yBazin = parseFloat(document.getElementById('yieldBazin').value) / 100;
        const payout = parseFloat(document.getElementById('payout').value) / 100;

        // C√°lculos FCFE e Bazin
        const fcfe = lucro + depre - capex - ncgVar;
        const precoDCF = ((fcfe * (1+g)) / (ke - g) * 1000000) / numAcoes;
        const dpa = (lucro * payout * 1000000) / numAcoes;
        const precoBazin = dpa / yBazin;

        // Indicadores de Qualidade
        const fco = lucro + depre - ncgVar;
        const efCaixa = (ebit - ncgVar) / ebit;
        const accruals = (lucro - fco) / ativo;
        const cashMargin = (fco - (lucro * 0.15)) / receita; // FCO - IR est.
        const ncgReceita = ncgVar / receita;

        const res = document.getElementById('resultado');
        res.classList.remove('hidden');
        res.innerHTML = `
            <div class="res-grid">
                <div class="val-box dcf-box">
                    <h3>Pre√ßo Justo DCF</h3>
                    <div class="price">R$ ${precoDCF.toLocaleString('pt-BR', {maximumFractionDigits:2})}</div>
                    <p>Foco: Gera√ß√£o de Caixa Livre</p>
                </div>
                <div class="val-box bazin-box">
                    <h3>Pre√ßo Teto Bazin</h3>
                    <div class="price">R$ ${precoBazin.toLocaleString('pt-BR', {maximumFractionDigits:2})}</div>
                    <p>Foco: Dividendos (${(yBazin*100)}% Yield)</p>
                </div>
            </div>

            <div class="card" style="margin-top:20px">
                <h2>Qualidade e Efici√™ncia (Combo de Qualidade)</h2>
                <table>
                    <tr><th>Indicador</th><th>Valor</th><th>An√°lise</th></tr>
                    <tr><td><b>Accruals Ratio</b></td><td>${accruals.toFixed(4)}</td><td>${accruals < 0 ? "‚úÖ Alta Qualidade" : "‚ö†Ô∏è Lucro Cont√°bil"}</td></tr>
                    <tr><td><b>Efici√™ncia de Caixa</b></td><td>${(efCaixa*100).toFixed(2)}%</td><td>${efCaixa > 0.8 ? "‚úÖ Excelente" : "‚ö†Ô∏è Monitorar"}</td></tr>
                    <tr><td><b>Margem de Fluxo de Caixa</b></td><td>${(cashMargin*100).toFixed(2)}%</td><td>Convers√£o de Venda em Caixa Real</td></tr>
                    <tr><td><b>NCG / Receita L√≠quida</b></td><td>${(ncgReceita*100).toFixed(2)}%</td><td>Necessidade de Capital de Giro</td></tr>
                </table>
            </div>
        `;
    }
</script>
</body>
</html>
