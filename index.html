<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Terminal Fleuriet & NCG Hist贸rica</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
body {
    font-family: Arial, sans-serif;
    background: #f4f6f8;
    padding: 20px;
}
.card {
    background: #ffffff;
    padding: 20px;
    border-radius: 10px;
    margin-bottom: 20px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
h1, h2 {
    color: #2c5282;
}
.grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 15px;
}
label {
    font-size: 12px;
    font-weight: bold;
    color: #555;
}
input {
    width: 100%;
    padding: 8px;
    margin-top: 3px;
}
table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
}
th, td {
    padding: 8px;
    border-bottom: 1px solid #ddd;
    text-align: center;
}
th {
    background: #edf2f7;
}
.ok { color: green; font-weight: bold; }
.bad { color: red; font-weight: bold; }
</style>
</head>

<body>

<div class="card">
<h1> Terminal Fleuriet + NCG Hist贸rica</h1>
<input type="file" id="upload" accept=".xlsx,.xls">
<p>Abas esperadas: <b>Bal. Patrim.</b> e <b>Dem. Result.</b></p>
</div>

<div class="card">
<h2> Dados do ltimo Ano</h2>
<div class="grid">
<div><label>Ativo Total</label><input id="ativo"></div>
<div><label>Patrim么nio L铆quido</label><input id="pl"></div>
<div><label>Caixa</label><input id="caixa"></div>
<div><label>D铆vida CP</label><input id="divida"></div>
<div><label>ACO</label><input id="aco"></div>
<div><label>PCO</label><input id="pco"></div>
<div><label>NCG</label><input id="ncg"></div>
<div><label>Tesouraria</label><input id="tesouraria"></div>
</div>
</div>

<div class="card">
<h2> NCG Hist贸rica</h2>
<table id="tabelaNCG">
<thead>
<tr>
<th>Ano</th>
<th>ACO</th>
<th>PCO</th>
<th>NCG</th>
<th>Diagn贸stico</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<script>
document.getElementById("upload").addEventListener("change", function(e) {

const reader = new FileReader();

reader.onload = function(evt) {

const wb = XLSX.read(new Uint8Array(evt.target.result), { type: "array" });
const bp = XLSX.utils.sheet_to_json(wb.Sheets["Bal. Patrim."], { header: 1, defval: "" });

function num(v) {
    return Number(
        String(v)
        .replace(/\./g,'')
        .replace(',','.')
        .replace(/[^\d\-\.]/g,'')
    ) || 0;
}

function findRow(term) {
    return bp.find(r => r.some(c => String(c).toLowerCase().includes(term)));
}

function lastCol(row) {
    for (let i = row.length - 1; i >= 0; i--) {
        if (row[i] !== "") return i;
    }
    return null;
}

const contasReceber = findRow("contas a receber");
const estoques = findRow("estoques");
const fornecedores = findRow("fornecedores");
const caixaRow = findRow("caixa");
const dividaRow = findRow("empr茅stimos");
const ativoRow = findRow("ativo total");
const plRow = findRow("patrim么nio");

const anos = bp[0].slice(1);

const tbody = document.querySelector("#tabelaNCG tbody");
tbody.innerHTML = "";

anos.forEach((ano, i) => {

const col = i + 1;

const aco = num(contasReceber[col]) + num(estoques[col]);
const pco = num(fornecedores[col]);
const ncg = aco - pco;

let diag = "Equil铆brio";
let classe = "";

if (ncg > 0) { diag = "Consome Caixa"; classe = "bad"; }
if (ncg < 0) { diag = "Gera Caixa"; classe = "ok"; }

tbody.innerHTML += `
<tr>
<td>${ano}</td>
<td>${aco.toLocaleString()}</td>
<td>${pco.toLocaleString()}</td>
<td>${ncg.toLocaleString()}</td>
<td class="${classe}">${diag}</td>
</tr>
`;
});

// ltimo ano
const last = anos.length;

const acoAtual = num(contasReceber[last]) + num(estoques[last]);
const pcoAtual = num(fornecedores[last]);
const ncgAtual = acoAtual - pcoAtual;
const tesouraria = num(caixaRow[last]) - num(dividaRow[last]);

document.getElementById("aco").value = acoAtual;
document.getElementById("pco").value = pcoAtual;
document.getElementById("ncg").value = ncgAtual;
document.getElementById("tesouraria").value = tesouraria;

document.getElementById("ativo").value = num(ativoRow[last]);
document.getElementById("pl").value = num(plRow[last]);
document.getElementById("caixa").value = num(caixaRow[last]);
document.getElementById("divida").value = num(dividaRow[last]);

};

reader.readAsArrayBuffer(e.target.files[0]);

});
</script>

</body>
</html>
