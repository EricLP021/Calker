<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valuation Pro - Trimodal & Cont√≠nua</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root { --primary: #2c5282; --secondary: #2b6cb0; --success: #2f855a; --warning: #ed8936; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f7fafc; padding: 20px; color: #2d3748; }
        .container { max-width: 1200px; margin: 0 auto; }
        .card { background: white; border-radius: 12px; padding: 25px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 1px solid #e2e8f0; }
        h1, h2 { color: var(--primary); margin-bottom: 15px; }
        .grid { display: grid; gap: 15px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
        label { display: block; font-weight: bold; font-size: 11px; color: #718096; text-transform: uppercase; margin-bottom: 5px; }
        input { width: 100%; padding: 10px; border: 2px solid #edf2f7; border-radius: 6px; font-size: 14px; transition: 0.2s; }
        input:focus { border-color: var(--secondary); outline: none; }
        .auto-filled { background-color: #ebf8ff; border-color: #bee3f8; }
        .btn { padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; font-size: 16px; transition: 0.3s; margin-top: 20px; }
        .btn-calc { background: var(--success); color: white; }
        .btn-calc:hover { background: #276749; transform: translateY(-1px); }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #edf2f7; }
        th { background: #f8fafc; font-size: 12px; color: #718096; }
        .highlight { font-weight: bold; color: var(--primary); }
        .res-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .val-card { padding: 30px; border-radius: 12px; text-align: center; color: white; }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <h1>üìä Terminal de Valuation (Refer√™ncia Trimodal)</h1>
        <p>Referenciando abas: <b>Bal. Patrim.</b> e <b>Dem. Result.</b></p>
        <input type="file" id="upload" accept=".xlsx, .xls" style="margin-top:15px; padding:10px; border:2px dashed #cbd5e0; width:100%;">
    </div>

    <div class="card">
        <h2>üõ†Ô∏è Dados Extra√≠dos (Revis√£o)</h2>
        <div class="grid">
            <div class="input-group"><label>Receita L√≠quida</label><input type="number" id="receita" class="auto-filled"></div>
            <div class="input-group"><label>EBIT</label><input type="number" id="ebit" class="auto-filled"></div>
            <div class="input-group"><label>Lucro L√≠quido</label><input type="number" id="lucro" class="auto-filled"></div>
            <div class="input-group"><label>Ativo Total</label><input type="number" id="ativo" class="auto-filled"></div>
            <div class="input-group"><label>Patrim√¥nio L√≠quido</label><input type="number" id="pl" class="auto-filled"></div>
            <div class="input-group"><label>Ativo Operacional (ACO)</label><input type="number" id="aco" class="auto-filled"></div>
            <div class="input-group"><label>Passivo Operacional (PCO)</label><input type="number" id="pco" class="auto-filled"></div>
            <div class="input-group"><label>Caixa/Disponibilidades</label><input type="number" id="caixa" class="auto-filled"></div>
            <div class="input-group"><label>Empr√©stimos CP</label><input type="number" id="dividaCP" class="auto-filled"></div>
            <div class="input-group"><label style="color:var(--warning)">CAPEX</label><input type="number" id="capex" placeholder="Ver aba fluxo"></div>
            <div class="input-group"><label style="color:var(--warning)">Deprecia√ß√£o</label><input type="number" id="depre" placeholder="Ver aba DRE"></div>
            <div class="input-group"><label style="color:var(--warning)">N¬∫ de A√ß√µes</label><input type="number" id="acoes"></div>
        </div>
        <button class="btn btn-calc" onclick="calcularValuation()">RODAR AN√ÅLISE COMPLETA</button>
    </div>

    <div id="resultado"></div>
</div>

<script>
    let dadosImportados = {};

    document.getElementById('upload').addEventListener('change', function(e) {
        const reader = new FileReader();
        reader.onload = function(evt) {
            const data = new Uint8Array(evt.target.result);
            const workbook = XLSX.read(data, {type: 'array'});

            // Mapeamento das Abas
            const sheetBP = workbook.Sheets["Bal. Patrim."];
            const sheetDRE = workbook.Sheets["Dem. Result."];

            if(!sheetBP || !sheetDRE) {
                alert("Abas 'Bal. Patrim.' ou 'Dem. Result.' n√£o encontradas!");
                return;
            }

            const jsonBP = XLSX.utils.sheet_to_json(sheetBP, {header: 1});
            const jsonDRE = XLSX.utils.sheet_to_json(sheetDRE, {header: 1});

            // Captura os dados da √öLTIMA coluna preenchida (Refer√™ncia Trimodal)
            const colIdx = jsonBP[0].length - 1; 

            const buscarValor = (json, termo) => {
                let linha = json.find(r => String(r[0]).toLowerCase().includes(termo.toLowerCase()));
                return linha ? parseFloat(String(linha[colIdx]).replace(/\./g, '').replace(',', '.')) : 0;
            };

            // Extra√ß√£o Balan√ßo
            document.getElementById('ativo').value = buscarValor(jsonBP, "Ativo Total");
            document.getElementById('pl').value = buscarValor(jsonBP, "Patrim√¥nio L√≠quido");
            document.getElementById('caixa').value = buscarValor(jsonBP, "Caixa e Equivalentes");
            document.getElementById('dividaCP').value = buscarValor(jsonBP, "Empr√©stimos e Financiamentos");
            
            // L√≥gica Fleuriet (Simplificada p/ exemplo - busca ACO e PCO)
            const contasReceber = buscarValor(jsonBP, "Contas a Receber");
            const estoques = buscarValor(jsonBP, "Estoques");
            const fornecedores = buscarValor(jsonBP, "Fornecedores");
            document.getElementById('aco').value = contasReceber + estoques;
            document.getElementById('pco').value = fornecedores;

            // Extra√ß√£o DRE
            document.getElementById('receita').value = buscarValor(jsonDRE, "Receita L√≠quida");
            document.getElementById('ebit').value = buscarValor(jsonDRE, "EBIT");
            document.getElementById('lucro').value = buscarValor(jsonDRE, "Lucro L√≠quido");
        };
        reader.readAsArrayBuffer(e.target.files[0]);
    });

    function calcularValuation() {
        const v = {
            receita: parseFloat(document.getElementById('receita').value) || 0,
            ebit: parseFloat(document.getElementById('ebit').value) || 0,
            lucro: parseFloat(document.getElementById('lucro').value) || 0,
            ativo: parseFloat(document.getElementById('ativo').value) || 1,
            pl: parseFloat(document.getElementById('pl').value) || 1,
            aco: parseFloat(document.getElementById('aco').value) || 0,
            pco: parseFloat(document.getElementById('pco').value) || 0,
            caixa: parseFloat(document.getElementById('caixa').value) || 0,
            dividaCP: parseFloat(document.getElementById('dividaCP').value) || 0,
            capex: parseFloat(document.getElementById('capex').value) || 0,
            depre: parseFloat(document.getElementById('depre').value) || 0,
            acoes: parseFloat(document.getElementById('acoes').value) || 1
        };

        // 1. Fleuriet
        const ncg = v.aco - v.pco;
        const tesouraria = v.caixa - v.dividaCP;

        // 2. Combo de Qualidade
        const ebitda = v.ebit + v.depre;
        const efCaixa = (ebitda - (ncg * 0.1)) / ebitda; // ŒîNCG estimado em 10% do estoque p/ exemplo
        const accruals = (v.lucro - (v.lucro + v.depre)) / v.ativo; 
        const margemFCO = (v.lucro + v.depre - (ncg * 0.1)) / v.receita;

        // 3. Valuation (Assaf Neto)
        const nopat = v.ebit * 0.66; // IR 34%
        const reinvest = (v.capex - v.depre + (ncg * 0.05)) / nopat;
        const roic = nopat / (v.pl + v.dividaCP);
        const g = reinvest * roic;

        // 4. Pre√ßo Teto Bazin (8%)
        const fcfe = v.lucro + v.depre - v.capex;
        const precoTeto = (fcfe / v.acoes) / 0.08;

        document.getElementById('resultado').innerHTML = `
            <div class="res-grid">
                <div class="val-card" style="background:var(--primary)">
                    <h3>Pre√ßo Teto Bazin (8%)</h3>
                    <div style="font-size:32px; font-weight:bold;">R$ ${precoTeto.toLocaleString('pt-BR', {maximumFractionDigits:2})}</div>
                    <p>Baseado no Fluxo de Caixa Dispon√≠vel</p>
                </div>
                <div class="val-card" style="background:var(--success)">
                    <h3>Crescimento Sustent√°vel (g)</h3>
                    <div style="font-size:32px; font-weight:bold;">${(g * 100).toFixed(2)}%</div>
                    <p>Identidade: Reinvestimento x ROIC</p>
                </div>
            </div>

            <div class="card" style="margin-top:20px">
                <h2>üìä Diagn√≥stico Trimodal (Fleuriet & Qualidade)</h2>
                <table>
                    <tr><th>Indicador</th><th>Valor</th><th>An√°lise</th></tr>
                    <tr><td><b>NCG / Receita L√≠quida</b></td><td>${((ncg/v.receita)*100).toFixed(2)}%</td><td>Necessidade de giro operacional</td></tr>
                    <tr><td><b>Saldo de Tesouraria</b></td><td>R$ ${tesouraria.toLocaleString()}</td><td>${tesouraria > 0 ? "‚úÖ Liquidez Ativa" : "‚ùå Risco de Tesouraria"}</td></tr>
                    <tr><td><b>Efici√™ncia de Caixa</b></td><td>${(efCaixa*100).toFixed(2)}%</td><td>Convers√£o de EBITDA em Caixa</td></tr>
                    <tr><td><b>Accruals Ratio</b></td><td>${accruals.toFixed(4)}</td><td>${accruals < 0 ? "‚úÖ Lucro de Alta Qualidade" : "‚ö†Ô∏è Lucro Cont√°bil"}</td></tr>
                    <tr><td><b>Cash Flow Margin</b></td><td>${(margemFCO*100).toFixed(2)}%</td><td>Gera√ß√£o real de caixa por real vendido</td></tr>
                </table>
            </div>
        `;
    }
</script>
</body>
</html>
